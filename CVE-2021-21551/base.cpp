#include "base.h"

base::base()
{
}

base::~base()
{
	if (hFile != INVALID_HANDLE_VALUE)
	{
		CloseHandle(hFile);
	}
}

bool base::sendDeviceIoControl(
	DWORD dwIoControlCode,
	LPVOID lpInBuffer,
	DWORD nInBufferSize,
	LPVOID lpOutBuffer,
	DWORD nOutBufferSize
)
{
	DWORD lpBytesReturned = 0;

	bool bStatus = DeviceIoControl(
		hFile,
		dwIoControlCode,
		lpInBuffer,
		nInBufferSize,
		lpOutBuffer,
		nOutBufferSize,
		&lpBytesReturned,
		NULL
	);

	return bStatus;
}

wchar_t* base::dellGle()
{
	wchar_t* err[MAXERRORLENGTH] = { 0 };

	FormatMessage(
		FORMAT_MESSAGE_ALLOCATE_BUFFER |
		FORMAT_MESSAGE_FROM_SYSTEM |
		FORMAT_MESSAGE_IGNORE_INSERTS,
		NULL,
		GetLastError(),
		MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
		reinterpret_cast<LPWSTR>(err),
		0,
		NULL
	);

	return *err;
}

bool base::init()
{
	hFile = CreateFile(
		L"\\\\.\\DBUtil_2_3",
		GENERIC_READ | GENERIC_WRITE,
		FILE_SHARE_READ | FILE_SHARE_WRITE,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);
	if (hFile == INVALID_HANDLE_VALUE)
	{
		wsprintf(e, L"[%ws::%d] %ws", __FUNCTIONW__, __LINE__, dellGle());
		return false;
	}

	return true;
}

wchar_t* base::what()
{
	return e;
}


/// EOF 